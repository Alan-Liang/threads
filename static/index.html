<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»„åº„å›å“é›†</title>
  <link rel="stylesheet" href="styles/base.css">
  <style>
    h3 { position: relative; }
    .order {
      user-select: none;
      opacity: 0.4;
    }
    @media (min-width: 1200px) {
      h3 {
        left: 1.05em;
      }
      .order {
        position: absolute;
        right: calc(100% + 0.5em);
      }
    }
    ul {
      margin-left: 1.25em;
      list-style: none;
      position: relative;
    }
    ul > li::before {
      content: '- ';
      position: absolute;
      right: calc(100% + 0.5em);
      opacity: 0.4;
    }
    .showall::before {
      opacity: 0;
    }
    .noscript-only {
      display: none;
    }
    .noscript .noscript-only {
      display: block;
    }
    .noscript #app {
      display: none;
    }
    li > .reply {
      opacity: 0;
      transition: x 0.3s ease;
      transition-property: opacity, background-color;
    }
    li:hover > .reply { opacity: 0.6; }
    form { display: inline; }
    main, .fullwidth { width: 100%; }
    ul.fullwidth {
      width: calc(100% - 1em);
    }
    .hide { opacity: 0; }
    hr {
      margin: 64px 0 32px;
      border: none;
      border-bottom: 1px solid #ccc;
    }
    .meta {
      opacity: 0.6;
      text-align: center;
    }
    h1 {
      display: flex;
      align-items: center;
    }
    .zhihu-link {
      margin-left: 1em;
      line-height: 1.5rem;
      font-weight: 400;
      position: relative;
      top: 4px;
    }
    @media (max-width: 618px) {
      h1 {
        display: block;
      }
      .zhihu-link {
        display: block;
        margin-left: -0.25rem;
      }
    }
  </style>
</head>
<body class="noscript">
  <script>
    window.es6Supported = `` || true
  </script>
  <script>
    if (window.es6Supported) document.body.classList.remove('noscript')
  </script>
  <main>
    <h1>é»„åº„å›å“é›†<a class="button zhihu-link" href="/zhihu/" style="text-decoration:none">å¦‚ä½•è¯„ä»· â†’</a></h1>
    <script>
      if (location.pathname.includes('/zhihu/')) document.querySelector('h1').innerHTML = `
      <h1>é»„åº„å›å“é›†Â·å¦‚ä½•è¯„ä»·<a class="button zhihu-link" href="/" style="text-decoration:none">å›åˆ°é»„åº„å›å“é›† â†’</a></h1>
      `
    </script>
    <p>ğŸ’«äº”æ¹–å››æµ·ï¼Œçº¢ç™½æƒ…ç‰µï¼Œèº«åœ¨ä¸–é—´å„å¤„çš„æˆ‘ä»¬ï¼Œå¯¹è¿™å…±åŒçš„ã€æ°¸è¿œçš„RDFZå®¶å›­ï¼Œå……æ»¡äº†æ€€å¿µä¹Ÿå……æ»¡äº†å›å¿†ã€‚ğŸŸ¥    ğŸŸ¥</p>
    <p>åœ¨è¿™ä¸ªæ–‡æ¡£é‡Œï¼Œå¯å†™ä¸‹ä½ åœ¨äººå¤§é™„ä¸­çš„äº‹ï¼Œæ‹¾å–é‚£äº›é—ªé—ªå‘å…‰çš„è®°å¿†ç¢ç‰‡âœ¨ä¹Ÿå¯ä¸å°ä¼™ä¼´ä»¬å…±åŒç•…è°ˆï¼Œäº¤æ¢å½¼æ­¤çš„å¿«ä¹ã€‚ğŸ‘«ğŸ‘­ </p>
    <p>æ¬¢è¿å¤§å®¶åˆ†äº«ç»™èº«è¾¹çš„RDFZersæ¥ä¸€èµ·å¡«å†™ï¼ï¼ğŸ¥³ï¼ˆ\æ¬¢å‘¼/ï¼‰ğŸ¥³</p>
    <div class="noscript-only">
      <br><br>
      æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒç°ä»£ JavaScriptï¼Œè€Œæˆ‘ä»¬éœ€è¦ç°ä»£ JavaScript æ‰èƒ½ä¸ºæ‚¨å±•ç¤ºå†…å®¹ã€‚
    </div>
    <div id="app">
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
  <script src="socket.io/socket.io.js"></script>
  <script>
    let keyword = localStorage.THREADS_KEYWORD, connected = false
    const ask = () => {
      if (!keyword) keyword = prompt('SSID ä¸º guest çš„ WiFi çš„å¯†ç æ˜¯ï¼Ÿï¼ˆ8 ä¸ªå­—æ¯ï¼Œå¯èƒ½æœ‰ä¸¤ç§ç­”æ¡ˆï¼Œéƒ½ç®—å¯¹ï¼‰', '')
      return keyword
    }
    const socket = io('/', { auth: { token: ask() }, path: location.pathname + '/socket.io' })
    socket.on('disconnect', () => {
      alert('è¿æ¥å·²æ–­å¼€, è¯·åˆ·æ–°é¡µé¢')
    })
    socket.on('connect_error', () => {
      if (connected) return
      localStorage.THREADS_KEYWORD = ''
      alert('è¿æ¥å·²æ–­å¼€, è¯·åˆ·æ–°é¡µé¢')
    })
    const shared = {
      state: [],
      nextThreadId: -1,
      inReply: false,
    }
    socket.on('init', (state, nextThreadId) => {
      connected = true
      shared.state = state
      shared.nextThreadId = nextThreadId
      localStorage.THREADS_KEYWORD = keyword
    })
    socket.on('thread', (thread, nextThreadId) => {
      Vue.set(shared.state, thread.id, thread)
      shared.nextThreadId = nextThreadId
    })
    socket.on('post', post => {
      shared.state[post.threadId].posts.push(post)
    })
    Vue.component('add-post', {
      props: { inReplyTo: Number, threadId: Number, cancellable: Boolean },
      data: () => ({ content: '' }),
      template: `
      <li><form @submit.prevent="go"><input v-model="content" ref="input"> <button type="submit">æ·»åŠ </button> &nbsp; <button v-if="cancellable" @click.prevent="$emit('cancel')">å–æ¶ˆ</button></form></li>
      `,
      methods: {
        go () {
          if (this.content) {
            socket.emit('post', this.content, this.threadId, this.inReplyTo)
            this.content = ''
          }
        },
        focus () {
          this.$refs.input.focus()
        },
      },
    })
    Vue.component('post', {
      props: { post: {}, thread: {} },
      data: () => ({ replyState: false }),
      template: `
      <li class="fullwidth">
        <span v-html="post.content.replace(/</g, '&amp;lt;').replace(/>/g, '&amp;gt;').replace(/&quot;/g, '&amp;quot;').replace(/\\n/g, '<br>')" />
        <button :class="{ hide: hideReply }" class="reply" @click="reply(true)">å›å¤</button>
        <ul class="fullwidth">
          <post v-for="subpost in thread.posts.filter(x => x.inReplyTo === post.id)" :key="subpost.id" :post="subpost" :thread="thread" />
          <add-post v-if="replyState" ref="addPost" :in-reply-to="post.id" :thread-id="thread.id" cancellable @cancel="reply(false)" />
        </ul>
      </li>
      `,
      methods: {
        reply (state) {
          this.replyState = shared.inReply = state
          if (state) this.$nextTick(() => this.$refs.addPost.focus())
        },
      },
      computed: {
        hideReply () { return shared.inReply },
      },
    })
    Vue.component('add-thread', {
      props: { id: Number },
      data: () => ({ content: '' }),
      template: `
      <h3><form @submit.prevent="go"><span class="order">{{ id }}.</span> <input v-model="content"> <button type="submit">æ·»åŠ </button></form></h3>
      `,
      methods: {
        go () {
          if (this.content) {
            socket.emit('thread', this.content)
            this.content = ''
          }
        },
      },
    })
    Vue.component('thread', {
      props: { thread: {} },
      data: () => ({ folded: true }),
      template: `
      <div class="fullwidth">
        <h3><span class="order">{{ thread.id }}.</span> <span v-html="thread.content.replace(/</g, '&amp;lt;').replace(/>/g, '&amp;gt;').replace(/&quot;/g, '&amp;quot;').replace(/\\n/g, '<br>')" /></h3>
        <ul class="fullwidth">
          <post v-for="post in postsToShow" :key="post.id" :post="post" :thread="thread" />
          <add-post v-if="!shouldFold || !folded" :thread-id="thread.id" :in-reply-to="-1" />
          <li v-if="shouldFold && folded" class="showall"><button @click="folded = false">æ˜¾ç¤ºå…¨éƒ¨ {{ thread.posts.length }} æ¡å›å¤â€¦</button></li>
          <li v-if="shouldFold && !folded" class="showall"><button @click="folded = true">æ”¶èµ·å›å¤</button></li>
        </ul>
      </div>
      `,
      computed: {
        shouldFold () { return this.posts.length > 6 },
        posts () { return this.thread.posts.filter(x => x.inReplyTo < 0) },
        postsToShow () {
          if (this.shouldFold && this.folded) return this.posts.slice(0, 4)
          return this.posts
        },
      },
    })
    new Vue({
      el: '#app',
      data: shared,
      template: `
      <div class="fullwidth">
        <template v-if="nextThreadId > 0">
          <thread v-for="thread in state.filter(Boolean)" :key="thread.id" :thread="thread"></thread>
          <add-thread :id="nextThreadId"></add-thread>
          <hr>
          <p class="meta"><a href="https://github.com/Alan-Liang/threads/" class="button" style="opacity:1; text-decoration:none">Threads</a> Â· World is Powered By Solitude</p>
        </template>
        <template v-else>
          åŠ è½½ä¸­â€¦â€¦
        </template>
      </div>
      `,
    })
  </script>
</body>
</html>
